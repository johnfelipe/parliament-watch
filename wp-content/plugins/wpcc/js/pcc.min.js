// version : 1.8
// author : Satish Sharma
// phploaded.com


wpcc_lang = new Array();
wpcc_lang[0] = 'Please enter your email address';
wpcc_lang[1] = 'Send Now';
wpcc_lang[2] = 'Total';
pcc_default_symbol = ' USD';
pcc_default_button_text = 'E-mail this to me';

jQuery(document).ready(function() {

jQuery('form.pcc-form select').prepend('<option selected="selected" data-cost="0"> --- Please Select --- </option>');

if(typeof(wpcc_domain)!=='undefined'){
pcc_calc_forms();

jQuery(document).on('click', '.pcc-mail-sender', function(){
var fidxx = jQuery('.wpcc-hidden-fid').val();
var fidx = fidxx.replace('-show', '');
var fdata = jQuery('#'+fidxx).find('.pcc-content').html();
var ftotal = jQuery('#'+fidxx).find('.pcc-total').html();
var xtra = {};
jQuery(".wpcc-xtra").each(function(i){
var xn = jQuery(this).attr('name');
var xv = jQuery(this).val();
xtra[xn] = xv;
});
var ymail = jQuery('.pcc-email').val();
if( !wpcc_validateEmail(ymail) || ymail=='') { pcc_alertx('The email address you provided seems incorrect. Please try agian...','Error...'); } else {
jQuery.post(ajaxurl, {action:'wpcc_mail', tot:ftotal, data:fdata, fid:fidx, xtr:xtra, mymail:ymail}, function(response) {
pcc_alertx(response,'Server response...');
});
}

});





jQuery(document).on('click', '.pcc-mail-send', function(){
var fidxx = jQuery(this).closest('.wpcc-preview').attr('id');
var xhtml = '<input type="hidden" class="wpcc-hidden-fid" value="'+fidxx+'" name="wpcc-hidden-fid" /><br /><br /><input type="text" class="pcc-email" name="pcc-email" /> <input type="button" class="pcc-mail-sender" value="'+wpcc_lang[1]+'" />';
pcc_alertx(xhtml,wpcc_lang[0]);
});




jQuery(document).on('keyup', '.pcc-form input[type="text"]', function(){
pcc_calc_forms();
});

jQuery(document).on('change', '.pcc-form select', function(){
pcc_calc_forms();
});

jQuery(document).on('change', '.pcc-form input[type="radio"]', function(){
pcc_calc_forms();
});

jQuery(document).on('change', '.pcc-form input[type="checkbox"]', function(){
pcc_calc_forms();
});

} // end conditional if

});
// end document ready


function pcc_alertx(a,b){
pcc_closex();
if(b==null || b==''){ var b='Message from server';}
var data = '<div class="dbg"></div><div class="dbug"><div align="center"><div class="dbugbox"><span class="dbugh">'+b+'</span><img class="dbugx" onclick="pcc_closex()" src="'+wpcc_domain+'/img/close.png"><span class="dbugm">'+a+'</span></div></div></div>';
jQuery("body").append(data);
jQuery('.dbug').fadeTo("slow","1");
}

function pcc_closex(){
jQuery('.dbg').remove();
jQuery('.dbug').remove();
}


function wpcc_validateEmail($email) {
  var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
  if( !emailReg.test( $email ) ) {
    return false;
  } else {
    return true;
  }
}


function pcc_calc_forms(){

jQuery(".pcc-form").each(function(i){
var formid = jQuery(this).attr('id');
if(jQuery(this).attr('data-curr')!='currency'){
pcc_symbol = jQuery(this).attr('data-curr');
} else {
pcc_symbol = pcc_default_symbol;
}

if(jQuery(this).attr('data-emtext')!='emtext'){
pcc_button_text = jQuery(this).attr('data-emtext');
} else {
pcc_button_text = pcc_default_button_text;
}

var x = pcc_form_data(formid);
jQuery("#"+formid+'-show').html('<h3 class="pcc-total">'+wpcc_lang[2]+' : '+pcc_float(x[0])+''+pcc_symbol+'</h3><div class="pcc-content">'+x[1]+'<br /><br /></div><input type="button" class="pcc-mail-send" value="'+pcc_button_text+'" />');
});

}


function pcc_float(a){
x = parseFloat(a);
var y = x.toFixed(5);
return parseFloat(y);
}


function pcc_form_data(fid){
var bcost = new Array(0, '');
var cbox = new Array();
var cboxttl = new Array();
jQuery('#'+fid+' input[type="text"]').each(function(i){
var t = jQuery(this).attr('data-title');
var x = jQuery(this).attr('data-cost');
var txxx = wpcc_replaceSubstring(jQuery(this).val(), ' ', '');

if(jQuery(this).is('[data-mult-from]')){
var mult_from = jQuery(this).attr('data-mult-from');
var mult = pcc_float(jQuery('[name="'+mult_from+'"]').val());
} else {
var mult = pcc_float(jQuery(this).attr('data-mult'));
}

if(isNaN(mult)){mult=1;}
var y = pcc_float(jQuery(this).val());
if(isNaN(y)){y=0;}
if(x!==undefined){
if(x=='this'){x=y;} else {x=pcc_float(x);}

if(txxx!=''){

bcost[0] = bcost[0] + (pcc_float(x*mult));
if(mult==1){
bcost[1] = bcost[1]+'<br /><b>'+t+'</b> : '+pcc_float(x)+''+pcc_symbol;
} else {
bcost[1] = bcost[1]+'<br /><b>'+t+'</b> : '+pcc_float(x)+' X '+mult+' = '+pcc_float(x*mult)+''+pcc_symbol;
}

}

}
});


jQuery('#'+fid+' select').each(function(i){
var t = jQuery(this).attr('data-title');
var u = jQuery(this).find('option:selected').attr('data-title');
var x = jQuery(this).find('option:selected').html();
var txnx = x;
if(u===undefined){u=' ( '+x+' ) ';} else { u=' ( '+u+' ) '; }
var x = jQuery(this).find('option:selected').attr('data-cost');

if(jQuery(this).is('[data-mult-from]')){
var mult_from = jQuery(this).attr('data-mult-from');
var mult = pcc_float(jQuery('[name="'+mult_from+'"]').val());
} else {
var mult = pcc_float(jQuery(this).attr('data-mult'));
}

if(isNaN(mult)){mult=1;}

var y = pcc_float(jQuery(this).find('option:selected').text());
if(isNaN(y)){y=0;}
if(x!==undefined){
if(x=='this'){x=y;} else {x=pcc_float(x);}


if(txnx!=' --- Please Select --- '){


bcost[0] = bcost[0] + (pcc_float(x*mult));
if(mult==1){
bcost[1] = bcost[1]+'<br /><b>'+t+''+u+'</b> : '+pcc_float(x)+''+pcc_symbol;
} else {
bcost[1] = bcost[1]+'<br /><b>'+t+''+u+'</b> : '+pcc_float(x)+' X '+mult+' = '+pcc_float(x*mult)+''+pcc_symbol;
}


}


}
});


jQuery('#'+fid+' input[type="radio"]').each(function(i){
var t = jQuery(this).attr('data-title');
var n = jQuery(this).attr('name');
var u = jQuery('input[type="hidden"][name="'+n+'-name"]').attr('data-title');
if(jQuery(this).is(":checked")){
var x = jQuery('#'+fid+' input[type="radio"][name="'+n+'"]:checked').attr('data-cost');


if(jQuery('[name="'+n+'-name"][data-mult-from]').length==0){
var mult = pcc_float(jQuery('input[type="hidden"][name="'+n+'-name"]').attr('data-mult'));
} else {
var mult_from = jQuery('input[type="hidden"][name="'+n+'-name"]').attr('data-mult-from');
var mult = pcc_float(jQuery('[name="'+mult_from+'"]').val());
}

if(isNaN(mult)){mult=1;}



var y = pcc_float(jQuery('#'+fid+' input[type="radio"][name="'+n+'"]:checked').val());
if(isNaN(y)){y=0;}
if(x!==undefined){
if(x=='this'){x=y;} else {x=pcc_float(x);}
bcost[0] = bcost[0] + (pcc_float(x*mult));
if(mult==1){
bcost[1] = bcost[1]+'<br /><b>'+u+' ( '+t+' )</b> : '+pcc_float(x)+''+pcc_symbol;
} else {
bcost[1] = bcost[1]+'<br /><b>'+u+' ( '+t+' )</b> : '+pcc_float(x)+' X '+mult+' = '+pcc_float(x*mult)+''+pcc_symbol;
}
}
}
});















jQuery('#'+fid+' .wpcc-pcent-field').each(function(i){
var t = jQuery(this).attr('data-title');
var pcent = pcc_float(jQuery(this).attr('data-pcent'));
var pfield = jQuery(this).attr('data-field');
var x = jQuery('#'+fid+' [name="'+pfield+'"]').attr('data-cost');
var mult = pcc_float(jQuery('#'+fid+' [name="'+pfield+'"]').attr('data-mult'));
if(isNaN(mult)){mult=1;}
var y = pcc_float(jQuery('#'+fid+' [name="'+pfield+'"]').val());
if(isNaN(y)){y=0;}
if(x!==undefined){
if(x=='this'){x=y;} else {x=pcc_float(x);}

bcost[0] = bcost[0] + (pcc_float(x*mult*pcent/100));
if(mult==1){
bcost[1] = bcost[1]+'<br /><b>'+t+'</b> : '+pcent+'% of '+pcc_float(x)+' = '+pcc_float(x*pcent/100)+''+pcc_symbol;
} else {
bcost[1] = bcost[1]+'<br /><b>'+t+'</b> : '+pcent+'% of '+pcc_float(x*mult)+' = '+pcc_float(x*mult*pcent/100)+''+pcc_symbol;
}

}
});












var u = '';
jQuery('#'+fid+' input[type="checkbox"]').each(function(i){
var n = jQuery(this).attr('name');
var nn = n.replace('[]', '');
var t = jQuery(this).attr('data-title');
cboxttl[nn] = jQuery('input[type="hidden"][name="'+nn+'-name"]').attr('data-title');
if(cboxttl[nn]===undefined){cboxttl[nn]='';}
if(jQuery(this).is(":checked")){
var x = jQuery(this).attr('data-cost');

if(jQuery('[name="'+nn+'-name"][data-mult-from]').length==0){
var mult = pcc_float(jQuery('input[type="hidden"][name="'+nn+'-name"]').attr('data-mult'));
} else {
var mult_from = jQuery('input[type="hidden"][name="'+nn+'-name"]').attr('data-mult-from');
var mult = pcc_float(jQuery('[name="'+mult_from+'"]').val());
}

if(isNaN(mult)){mult=1;}

var y = pcc_float(jQuery(this).val());
if(isNaN(y)){y=0;}
if(x!==undefined){
if(x=='this'){x=y;} else {x=pcc_float(x);}
bcost[0] = bcost[0] + pcc_float(x*mult);
if(cbox[nn]===undefined){cbox[nn]='';}
if(mult==1){
cbox[nn] = cbox[nn]+'<li><b>'+t+'</b> : '+pcc_float(x)+''+pcc_symbol+'</li>';
} else {
cbox[nn] = cbox[nn]+'<li><b>'+t+'</b> : '+pcc_float(x)+' X '+mult+' = '+pcc_float(x*mult)+''+pcc_symbol+'</li>';
}
}
}
});







jQuery('#'+fid+' .wpcc-pcent-total').each(function(i){
var t = jQuery(this).attr('data-title');
var pcent = pcc_float(jQuery(this).attr('data-pcent'));

bcost[1] = bcost[1]+'<br /><br /><b>'+t+'</b> :<br /><b><i>Total before applying '+pcent+'% was '+bcost[0]+' '+pcc_symbol+'</i></b><br /><b><i>'+pcent+'% of '+bcost[0]+' is '+pcc_float(bcost[0]*pcent/100)+''+pcc_symbol+'</i></b><br /><b><i>Total after applying '+pcent+'% is '+pcc_float((bcost[0]*pcent/100)+bcost[0])+''+pcc_symbol+'</i></b><br />';

bcost[0] = bcost[0] + (pcc_float(bcost[0]*pcent/100));

});






for (key in cbox) {
bcost[1] = bcost[1]+'<fieldset><legend>'+cboxttl[key]+'</legend><ul>'+cbox[key]+'</ul></fieldset>';
}
cbox = [];
cboxttl = [];

return bcost;
}

function delete_wpcc(id){
if(confirm('Are you sure to delete this form?')){
document.location.href = 'admin.php?page=wpcc-settings.php&delete='+id;
}
}

function wpcc_replaceSubstring(inSource, inToReplace, inReplaceWith){
var outString = inSource;
while (true) {
var idx = outString.indexOf(inToReplace);
if (idx == -1) {
break;}
outString = outString.substring(0, idx) + inReplaceWith +
outString.substring(idx + inToReplace.length);
}return outString;
}